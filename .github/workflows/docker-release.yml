name: Docker Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build (e.g., v1.0.0)'
        required: true
        default: 'latest'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=tag
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=${{ github.event.inputs.tag }},enable=${{ github.event_name == 'workflow_dispatch' }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  create-release:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get tag name
        id: get_tag
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create docker-compose file for release
        run: |
          cat > docker-compose-release.yml << EOF
          version: '3'
          
          services:
            yuque-sync:
              image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.get_tag.outputs.tag }}
              container_name: yuque-sync
              restart: always
              volumes:
                - ./data:/data
              environment:
                # å¿…é¡»è®¾ç½®çš„çŽ¯å¢ƒå˜é‡ï¼ˆè¯·æ›¿æ¢ä¸ºä½ çš„å®žé™…å€¼ï¼‰
                - YUQUE_TOKEN=your_yuque_token_here
                - YUQUE_SESSION=your_yuque_session_here
                
                # å¯é€‰çš„çŽ¯å¢ƒå˜é‡ï¼ˆå·²æœ‰é»˜è®¤å€¼ï¼‰
                - YUQUE_BASE_URL=https://www.yuque.com
                - SAVE_PATH=/data
                - MONITOR_INTERVAL_MINUTES=10
                - EXPORT_FORMAT=pdf
          EOF

      - name: Create usage instructions
        run: |
          cat > USAGE.md << 'EOF'
          # YuqueSync Docker ä½¿ç”¨è¯´æ˜Ž
          
          ## å¿«é€Ÿå¼€å§‹
          
          ### 1. èŽ·å–è¯­é›€å‡­è¯
          
          1. æ‰“å¼€æµè§ˆå™¨ï¼Œç™»å½•è¯­é›€
          2. æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·
          3. åˆ‡æ¢åˆ° Network æ ‡ç­¾
          4. åˆ·æ–°é¡µé¢ï¼Œæ‰¾åˆ°ä»»æ„ä¸€ä¸ªè¯·æ±‚
          5. åœ¨è¯·æ±‚å¤´ä¸­æ‰¾åˆ°ï¼š
             - `yuque_ctoken`: è¿™æ˜¯ä½ çš„ YUQUE_TOKEN
             - `_yuque_session`: è¿™æ˜¯ä½ çš„ YUQUE_SESSION
          
          ### 2. ä½¿ç”¨ Docker è¿è¡Œ
          
          ```bash
          # æ–¹å¼ä¸€ï¼šç›´æŽ¥è¿è¡Œ
          docker run -d \
            --name yuque-sync \
            --restart always \
            -e YUQUE_TOKEN="ä½ çš„token" \
            -e YUQUE_SESSION="ä½ çš„session" \
            -v ./data:/data \
            ghcr.io/d5v/yuquesync:latest
          
          # æ–¹å¼äºŒï¼šä½¿ç”¨ docker-composeï¼ˆæŽ¨èï¼‰
          # 1. ä¸‹è½½ docker-compose-release.yml
          # 2. ç¼–è¾‘å…¶ä¸­çš„çŽ¯å¢ƒå˜é‡
          # 3. è¿è¡Œï¼š
          docker-compose -f docker-compose-release.yml up -d
          ```
          
          ### 3. çŽ¯å¢ƒå˜é‡é…ç½®
          
          | çŽ¯å¢ƒå˜é‡ | å¿…éœ€ | é»˜è®¤å€¼ | è¯´æ˜Ž |
          |---------|------|--------|------|
          | `YUQUE_TOKEN` | âœ… | - | è¯­é›€ Token |
          | `YUQUE_SESSION` | âœ… | - | è¯­é›€ Session |
          | `YUQUE_BASE_URL` | âŒ | `https://www.yuque.com` | è¯­é›€ç½‘ç«™åœ°å€ |
          | `SAVE_PATH` | âŒ | `/data` | æ–‡æ¡£ä¿å­˜è·¯å¾„ |
          | `MONITOR_INTERVAL_MINUTES` | âŒ | `10` | åŒæ­¥é—´éš”ï¼ˆåˆ†é’Ÿï¼‰ |
          | `EXPORT_FORMAT` | âŒ | `pdf` | å¯¼å‡ºæ ¼å¼ï¼ˆpdf æˆ– markdownï¼‰ |
          
          ### 4. æŸ¥çœ‹æ—¥å¿—
          
          ```bash
          docker logs -f yuque-sync
          ```
          
          ### 5. åœæ­¢æœåŠ¡
          
          ```bash
          docker stop yuque-sync
          docker rm yuque-sync
          ```
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_tag.outputs.tag }}
          name: Release ${{ steps.get_tag.outputs.tag }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            docker-compose-release.yml
            USAGE.md
          body: |
            ## ðŸ³ Docker é•œåƒå‘å¸ƒ
            
            ### é•œåƒä¿¡æ¯
            - **é•œåƒåœ°å€**: `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.get_tag.outputs.tag }}`
            - **æ”¯æŒæž¶æž„**: linux/amd64, linux/arm64
            - **å¯¼å‡ºæ ¼å¼**: PDFï¼ˆé»˜è®¤ï¼‰å’Œ Markdown
            
            ### å¿«é€Ÿå¯åŠ¨
            ```bash
            docker run -d \
              --name yuque-sync \
              --restart always \
              -e YUQUE_TOKEN="ä½ çš„token" \
              -e YUQUE_SESSION="ä½ çš„session" \
              -v ./data:/data \
              ghcr.io/d5v/yuquesync:latest
            ```
            
            ### ðŸ“ ä¸‹è½½æ–‡ä»¶
            - `docker-compose-release.yml`: Docker Compose é…ç½®æ–‡ä»¶
            - `USAGE.md`: è¯¦ç»†ä½¿ç”¨è¯´æ˜Ž
            
            æ›´å¤šä½¿ç”¨è¯´æ˜Žè¯·æŸ¥çœ‹ [é¡¹ç›®æ–‡æ¡£](https://github.com/${{ github.repository }})
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 